# ğŸ® Stellar Federation (Unity)

Use this quest log to navigate the Unity farming client and the Stellar-backed Beamable microservice.

## ğŸ—ºï¸ Map of the Realm
- ğŸ“‚ Game scripts: `Assets/Game/Scripts/Beam`, `Assets/Game/Scripts/MainMenu`, `Assets/Game/Scripts/Stellar`.
- ğŸ›°ï¸ Microservice: `BeamableServices/services/StellarFederation` + shared `StellarFederationCommon` + storage `StellarFederationStorage`.
- ğŸ¤– Generated client: `Assets/Beamable/AutoGenerated/Microservices/StellarFederationClient.cs`.
- ğŸŒ± Federated content: `BeamableServices/services/StellarFederationCommon/FederationContent` (coins, gold, crops).

## â–¶ï¸ Unity Gameplay Loop
- ğŸ”§ `BeamManager` boots `BeamContext`, caches `StellarFederationClient`, then initializes managers in inspector order.
- ğŸªª `BeamAccountManager` manages Beam accounts, listens for custodial account creation, and attaches `StellarWeb3Identity`.
- ğŸ“œ `BeamContentManager` resolves federated content refs (coins/crops) and loads crop data from Resources.
- ğŸŒ¾ `BeamInventoryManager` subscribes to inventory updates, ensures the default crop exists, syncs crop instance properties, and pushes updates via `_stellarClient.UpdateItems`.
- ğŸ›’ `BeamCommerceManager` resolves store listings, purchases via Beam commerce, and updates on-chain currency through `_stellarClient.UpdateCurrency`.
- ğŸ›ï¸ UI: `MainMenu/UiAccountController` blocks play until a Stellar ID exists; `StellarExternalWalletController` runs the external wallet link flow (address + signature callbacks).

## ğŸŒ¾ Farming Gameplay Loop (Beamable-Powered)
- ğŸª“ Plant: default crop is auto-granted if missing; new crop NFTs are minted/added via `_stellarClient.AddItem` with seeds/yield properties.
- â³ Grow & Track: crop instances keep seeds left and yield amounts in Beam inventory properties; `BeamInventoryManager` refreshes and caches these per-instance values.
- ğŸšœ Harvest & Spend: yields and currency updates call `UpdateItems` and `UpdateCurrency`, queuing on-chain mints/transfers before Beam inventory proxy reloads.
- ğŸ›ï¸ Shop Sync: `BeamCommerceManager` pulls Beam store listings; purchases go through Beam commerce (`CommerceService.Purchase`) and then update crop state so seeds/yields reflect the new item.
- ğŸ”„ Persistence: inventory state is federated via the microservice, so crops/currencies survive sessions and stay consistent between Unity and Stellar.

## ğŸ§  Microservice Core (StellarFederation)
- ğŸ“ Location: `BeamableServices/services/StellarFederation`.
- ğŸªª Identity namespaces: custodial `StellarWeb3Identity`, external `StellarWeb3ExternalIdentity` (`StellarFederationCommon/StellarFederationCommon.cs`).
- ğŸš€ Startup (`Program.cs`): preload common assembly, prepare microservice, register shutdown hook, and start the hosted background worker.
- ğŸ§© DI: `ServiceRegistration.AddFeatures` auto-registers `IService` types; `Endpoints/ServiceRegistration` wires auth/inventory endpoints.
- âš™ï¸ Initialization (`StellarFederation.InitializeServices`): set up Mongo extensions, validate realm config, create realm wallet, initialize Soroban contracts, and start the scheduler (non-DEBUG builds).
- ğŸ“¡ Client-callables: `StellarConfiguration`, `CreateAccount`, `GetAccount`, inventory helpers (`UpdateCurrency`, `AddItem`, `RemoveItem`, `UpdateItems`), plus admin `Jobs`/`BlockProcessor`.
- ğŸ”” External callbacks: `ExternalAddress` and `ExternalSignature` feed wallet-connect bridge responses and trigger player notifications.

## ğŸ” Identity & Wallets
- ğŸ”’ Custodial path: `AccountsService` keeps encrypted seeds in `VaultCollection` (Mongo `vault`), auto-creates the realm wallet (`default-account`), and serves auth for Beam users with a stored wallet.
- ğŸŒ‰ External path: `AuthenticateExternalEndpoint` issues a signable challenge; `ExternalAuthService` stores it (`external_auth`) and pushes notifications. `StellarExternalWalletController` opens the bridge URL, receives address/signature notifications, and calls `AttachIdentity` to bind the external wallet.
- âœ… Signature checks: `StellarService.IsSignatureValid` verifies external signatures; custodial attach can skip tokens when a vault already exists.

## ğŸ” Key Wallet Flows
- ğŸ§‘â€ğŸŒ¾ New custodial player: Main menu -> `CreateAccount` (microservice) -> Beam notification `CustodialAccountCreated` -> `BeamAccountManager` attaches `StellarWeb3Identity` and switches accounts.
- ğŸŒ‰ External wallet link: UI opens bridge URL -> wallet posts address/signature to callbacks -> notifications drive `AttachIdentity` -> UI shows linked state.
- ğŸª™ Economy update: Game calls `_stellarClient.UpdateCurrency/AddItem/UpdateItems` -> request queued -> background worker mints/transfers on-chain -> block processor confirms -> Beam inventory proxy reloads.

## ğŸ’° Content, Contracts, Inventory
- ğŸ§© Federated content: `CoinCurrency`, `GoldCurrency`, `CropItem` set federation to `StellarFederation/StellarIdentity`; `BeamContentService` loads them for contract setup and state queries.
- ğŸ“œ Contracts: `ContractService.InitializeContentContracts` locks on the realm account, initializes Soroban client/CLI, creates contract wallets, and dispatches type-specific handlers to deploy/seed contracts.
- ğŸ“¦ Inventory state: `GetInventoryStateEndpoint` iterates federated content, uses handlers (`RegularCoinHandler`, `SupplyCoinHandler`) via `ContractProxy` to read balances, then caches proxy state in Mongo `inventory-state`.
- ğŸ“¨ Transaction entry: `StartInventoryTransactionEndpoint` logs requests (`TransactionLogCollection`), enqueues work in `transaction-queue` with concurrency keys, and returns the last known state.
- ğŸ”„ Processing: `StellarBackgroundService` polls `TransactionQueueCollection`, locks a work group, and hands batches to `TransactionProcessorService`; handlers mint/transfer coins or create accounts (`CoinCurrencyAddHandler`, `SupplyCurrencyAddHandler`, `AccountCreateHandler`).
- ğŸ›°ï¸ Reconciliation: scheduled `BlockProcessor` (`SchedulerService` cron or admin `Jobs/BlockProcessor`) reads Horizon/Soroban logs, marks transactions done, clears locks, updates vault created flags, and triggers player inventory reloads/notifications.

## ğŸ› ï¸ Configuration
- ğŸ§­ Realm config namespace: `stellar-federation` (`Configuration.cs`).
- ğŸ”‘ Key entries: `StellarRpc`, `StellarHorizon`, `StellarNetwork` (`public|test`), `WalletConnectBridgeUrl`, `AuthenticationChallengeTtlSec`, `NumberOfWorkingWallets`, batching/fee knobs (`MessageQueueBatchLimit`, `MessageQueueBatchLimitNative`, `BaseFeeInStroops`, `MinExtraResourceFeeInStroops`, `ExtraResourceFeePercentage`, `TransactionTimeoutSec`).
- ğŸ§ª Secret: realm secret pulled from `SECRET` env var for encrypting vault seeds.



